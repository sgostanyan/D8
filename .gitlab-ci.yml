# GitLab CI script for Drupal 8 websites.
# @see https://www.dx-experts.nl/blog/2018/drupal-8-and-gitlab-ci-setup-guide
# @see https://gitlab.com/dx-experts/drupal-templates-for-gitlab-ci
#
# This script deploys a Drupal 8 site on each commit on the master-branch.
#
# Preparation:
# Save $SSH_PRIVATE_KEY first in GitLab CI variables.
variables:
  GIT_ROOT: "/var/www/html/d8/application"
  SSH_LOGIN: "ssh -p22 -oStrictHostKeyChecking=no ubuntu@sarven.tk"

before_script:
  #- mkdir -p ~/.ssh
  #- echo "$SSH_PRIVATE_KEY" | tr -d '\r' > ~/.ssh/id_rsa
  #- chmod 700 ~/.ssh/id_rsa
  #- eval "$(ssh-agent -s)"
  #- ssh-add ~/.ssh/id_rsa
  #- ssh-keyscan -H 'gitlab.com' >> ~/.ssh/known_hosts
  - eval $(ssh-agent -s)
  - cd ~
  - touch id.rsa
  - echo "$SSH_PRIVATE_KEY" > id.rsa
  - chmod 700 id.rsa
  - ssh -o StrictHostKeyChecking=no -i id.rsa $SSH_USER@$SERVER

deploy_master:
  stage: deploy
  only:
    - master
  script:
    - $SSH_LOGIN "cd $GIT_ROOT && git pull && composer install && drush updb && drush cim -y && drush cr"
#  when: manual
